stages:
  - preparation
  - sonarQube
  - Build
  - release
### start of Preparation
Preparation:
  stage: preparation
  tags:
    - dev-runner
  script:
    - Stop-WebSite 'Default Web Site' ## stopping FrontEnd Website
    - Stop-WebSite 'TachyonProdCore' ## stopping Backend Website
  only:
    - develop
### end of Preparation
sonarqube-check:
  stage: sonarQube
  image: mcr.microsoft.com/dotnet/core/sdk:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - "apt-get update"
    - "apt-get install --yes openjdk-11-jre"
    - "cd ./aspnet-core/src/TACHYON.Web.Host"
    - "dotnet tool install --global dotnet-sonarscanner"
    - "export PATH=\"$PATH:$HOME/.dotnet/tools\""
    - "dotnet sonarscanner begin /k:\"tachyonhub_tachyon-core_AX5oYDhUYd6JI1APFRVn\" /d:sonar.login=\"$SONAR_TOKEN\" /d:\"sonar.host.url=$SONAR_HOST_URL\" "
    - "dotnet build"
    - "dotnet sonarscanner end /d:sonar.login=\"$SONAR_TOKEN\""
  allow_failure: true
  only:
    - merge_requests
### starting Build
Project:
  stage: Build
  tags:
    - dev-runner
  script:
    - Remove-Item 'C:\inetpub\wwwroot\Tachyon\outputs' -Force -Recurse
    - cd ./aspnet-core/build
    - ./build-with-ng.ps1
  only:
    - develop
## end of build
### start of release
release:
  stage: release
  tags:
    - dev-runner
  script:
    - dir
    - Start-WebSite 'TachyonProdCore' ##start Backend Site
    - Start-WebSite 'Default Web Site' ##start fronend Site
  only:
    - develop
