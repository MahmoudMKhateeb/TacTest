<div
  appBsModal
  #createOrEditModal="bs-modal"
  (onShown)="onShown()"
  class="modal fade"
  tabindex="-1"
  role="dialog"
  aria-labelledby="createOrEditModal"
  aria-hidden="true"
  [config]="{ backdrop: 'static', keyboard: !saving }"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form *ngIf="active" #userForm="ngForm" novalidate (ngSubmit)="save()">
        <div class="modal-header">
          <h4 *ngIf="!creatDriver" class="modal-title">
            <span *ngIf="user.id"> {{ 'Edit' | localize }} {{ 'User' | localize }}: {{ user.userName }}</span>
            <span *ngIf="!user.id">{{ 'Create' | localize }} {{ 'NewUser' | localize }}</span>
          </h4>
          <h4 *ngIf="creatDriver" class="modal-title">
            <span *ngIf="user.id">{{ 'Edit' | localize }} {{ 'Driver' | localize }}: {{ user.userName }}</span>
            <span *ngIf="!user.id">{{ 'Create' | localize }}{{ 'NewDriver' | localize }}</span>
          </h4>
          <button type="button" class="close" (click)="close()" [attr.aria-label]="l('Close')" [disabled]="saving">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <tabset>
            <tab class="pt-5" heading="{{ 'UserInformations' | localize }}">
              <div class="row">
                <div class="col-sm-3 text-center mb-5 mt-5">
                  <img src="{{ profilePicture }}" width="128" height="128" class="img-thumbnail img-rounded" />
                </div>
                <div class="col-sm-9">
                  <div class="row">
                    <!--                    <div class="form-group col-6">-->
                    <!--                      <label for="EmailAddress">{{ 'EmailAddress' | localize }} *</label>-->
                    <!--                      <input-->
                    <!--                        id="EmailAddress"-->
                    <!--                        #emailAddressInput="ngModel"-->
                    <!--                        type="email"-->
                    <!--                        name="EmailAddress"-->
                    <!--                        class="form-control"-->
                    <!--                        [(ngModel)]="user.emailAddress"-->
                    <!--                        required-->
                    <!--                        (change)="removeWhiteSpacesFromEmail()"-->
                    <!--                        maxlength="256"-->
                    <!--                        email-->
                    <!--                      />-->
                    <!--                      <span *ngIf="!isEmailValid" class="form-text text-danger">{{ l('NotValid') }}</span>-->
                    <!--                      <span *ngIf="!isEmailAvailable" class="form-text text-danger">{{ l('AlreadyTaken') }}</span>-->
                    <!--                      <validation-messages [formCtrl]="emailAddressInput"></validation-messages>-->
                    <!--                    </div>-->

                    <div class="form-group col-6">
                      <label for="UserName"><span class="text-danger">*</span> {{ 'PhoneNumber' | localize }}</label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text">+966</span>
                        </div>
                        <input
                          (input)="CheckIfDriverPhoneNumberIsValid(userNameInput.value, user.id)"
                          id="UserName"
                          #userNameInput="ngModel"
                          [disabled]="!canChangeUserName"
                          name="UserName"
                          pattern="^\d{9}$"
                          maxlength="9"
                          placeholder="{{ '9digitsNumber' | localize }}"
                          type="tel"
                          class="form-control"
                          [(ngModel)]="user.userName"
                          required
                          [ngClass]="{
                            'is-valid': !CheckingIfDriverPhoneNumberIsValid && isPhoneNumberAvilable && userNameInput.valid,
                            'is-invalid':
                              userForm.submitted && !CheckingIfDriverPhoneNumberIsValid && (!isPhoneNumberAvilable || !userNameInput.valid)
                          }"
                        />
                        <div class="input-group-append">
                          <span class="input-group-text">
                            <i [ngClass]="{ 'fa-spin': CheckingIfDriverPhoneNumberIsValid }" class="flaticon-refresh"></i>
                          </span>
                        </div>
                      </div>
                      <validation-messages [formCtrl]="userNameInput"></validation-messages>
                      <span
                        *ngIf="!CheckingIfDriverPhoneNumberIsValid && userNameInput.valid && !isPhoneNumberAvilable"
                        class="form-text text-danger"
                        >{{ l('AlreadyTaken') }}</span
                      >
                      <span
                        *ngIf="!CheckingIfDriverPhoneNumberIsValid && userNameInput.valid && isPhoneNumberAvilable"
                        class="form-text text-success"
                        >{{ l('Available') }}</span
                      >
                      <span class="help-block" *ngIf="!canChangeUserName">{{ 'CanNotChangeAdminUserName' | localize }}</span>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-6">
                      <div class="form-group">
                        <label for="Name"><span class="text-danger">*</span> {{ 'Name' | localize }}</label>
                        <input
                          id="Name"
                          #nameInput="ngModel"
                          class="form-control"
                          type="text"
                          name="Name"
                          [(ngModel)]="user.name"
                          required
                          maxlength="64"
                          [ngClass]="{
                            'is-valid': nameInput.valid,
                            'is-invalid': userForm.submitted && !nameInput.valid
                          }"
                        />
                        <validation-messages [formCtrl]="nameInput"></validation-messages>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="form-group">
                        <label for="Surname"><span class="text-danger">*</span> {{ 'Surname' | localize }}</label>
                        <input
                          id="Surname"
                          #surnameInput="ngModel"
                          type="text"
                          name="Surname"
                          class="form-control"
                          [(ngModel)]="user.surname"
                          required
                          maxlength="64"
                          [ngClass]="{
                            'is-valid': surnameInput.valid,
                            'is-invalid': userForm.submitted && !surnameInput.valid
                          }"
                        />
                        <validation-messages [formCtrl]="surnameInput"></validation-messages>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-6">
                  <div class="form-group">
                    <label for="Nationality"><span class="text-danger">*</span> {{ 'Nationality' | localize }}</label>
                    <select
                      id="Nationality"
                      #Nationality="ngModel"
                      name="Nationality"
                      [(ngModel)]="user.nationalityId"
                      required
                      class="form-control form-control-lg custom-select mr-sm-2"
                      [ngClass]="{
                        'is-valid': Nationality.valid,
                        'is-invalid': userForm.submitted && !Nationality.valid
                      }"
                    >
                      <option *ngFor="let nationality of nationalities" [value]="nationality.id">{{ nationality.displayName }}</option>
                    </select>
                    <validation-messages [formCtrl]="Nationality"></validation-messages>
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-group">
                    <label for="DateOfBirth">{{ 'DateOfBirth' | localize }}</label>
                    <div class="input-group date">
                      <input
                        type="datetime"
                        id="DateOfBirth"
                        #DateOfBirth
                        name="DateOfBirth"
                        class="form-control"
                        bsDatepicker
                        datePickerMomentModifier
                        [(date)]="user.dateOfBirth"
                        [bsConfig]="{ adaptivePosition: true }"
                        readonly
                        placeholder="Select date"
                      />
                      <div class="input-group-append">
                        <span class="input-group-text">
                          <i class="la la-calendar-check-o"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-6">
                  <div class="form-group">
                    <label for="Address">{{ 'Address' | localize }}</label>
                    <input id="Address" type="text" name="Address" class="form-control" [(ngModel)]="user.address" maxlength="256" />
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-group" *ngIf="user.isDriver">
                    <label for="ExperienceField">{{ 'ExperienceField' | localize }}</label>
                    <input
                      id="ExperienceField"
                      type="text"
                      name="DrivingLicenseNumber"
                      class="form-control"
                      [(ngModel)]="user.experienceField"
                      maxlength="256"
                    />
                  </div>
                </div>
              </div>

              <div class="checkbox-inline">
                <label for="EditUser_ShouldChangePasswordOnNextLogin" class="checkbox">
                  <input
                    id="EditUser_ShouldChangePasswordOnNextLogin"
                    type="checkbox"
                    name="ShouldChangePasswordOnNextLogin"
                    [(ngModel)]="user.shouldChangePasswordOnNextLogin"
                  />
                  {{ 'ShouldChangePasswordOnNextLogin' | localize }}
                  <span></span>
                </label>
                <label for="EditUser_IsActive" class="checkbox">
                  <input id="EditUser_IsActive" type="checkbox" name="IsActive" [(ngModel)]="user.isActive" />
                  {{ 'Active' | localize }}
                  <span></span>
                </label>

                <label *ngIf="isTwoFactorEnabled" for="EditUser_IsTwoFactorEnabled" class="checkbox">
                  <input id="EditUser_IsTwoFactorEnabled" type="checkbox" name="IsTwoFactorEnabled" [(ngModel)]="user.isTwoFactorEnabled" />
                  {{ 'IsTwoFactorEnabled' | localize }}
                  <span></span>
                </label>

                <label *ngIf="isLockoutEnabled" for="EditUser_IsLockoutEnabled" class="checkbox">
                  <input id="EditUser_IsLockoutEnabled" type="checkbox" name="IsLockoutEnabled" [(ngModel)]="user.isLockoutEnabled" />
                  {{ 'IsLockoutEnabled' | localize }}
                  <span></span>
                </label>
              </div>
            </tab>
            <tab *ngIf="!user.id && createOrEditDocumentFileDtos?.length > 0" class="pt-5" heading="{{ 'DriverDocuments' | localize }}">
              <div *ngFor="let item of createOrEditDocumentFileDtos; index as i" class="">
                <div *ngIf="i != 0" class="separator separator-dashed mb-5"></div>
                <div class="row">
                  <div class="form-group col-6">
                    <label class="text-success"
                      >* {{ item.documentTypeDto.name ? item.documentTypeDto.name : item.documentTypeDto.displayName }}</label
                    >
                    <div class="custom-file">
                      <input
                        accept="image/x-png,image/jpeg,application/pdf"
                        (change)="DocFileChangeEvent($event, item, i)"
                        type="file"
                        [disabled]="saving"
                        class="custom-file-input"
                        [required]="true"
                      />
                      <label class="custom-file-label text-truncate" [for]="item.documentTypeDto.displayName">
                        {{ item.name ? item.name : l('Select') + l('File') }}</label
                      >
                    </div>
                    <span class="form-text text-muted">{{ 'ValidDocumentFilesMsg' | localize }}</span>
                    <div *ngIf="!isFileFormatValid(i)">
                      <span class="form-text text-danger text-left">{{ 'PleaseChooseAvalidFormat' | localize }}</span>
                    </div>
                    <div *ngIf="isFileDuplicate(i)">
                      <span class="form-text text-danger text-left">{{ 'DuplicateFileUploadMsg' | localize }}</span>
                    </div>
                  </div>
                  <div *ngIf="item.documentTypeDto.hasNumber" class="form-group col-6">
                    <label>* {{ l('Number') }} </label>
                    <input
                      #inputDocumentNumber="ngModel"
                      name="number{{ i }}"
                      id="number{{ i }}"
                      class="form-control m-input"
                      required
                      [maxLength]="item.documentTypeDto.numberMaxDigits == 0 ? 50 : item.documentTypeDto.numberMaxDigits"
                      [minLength]="item.documentTypeDto.numberMinDigits"
                      type="text"
                      [(ngModel)]="item.number"
                      [ngClass]="{
                        'is-valid': inputDocumentNumber.valid,
                        'is-invalid': userForm.submitted && !inputDocumentNumber.valid
                      }"
                    />
                    <validation-messages [formCtrl]="inputDocumentNumber"></validation-messages>
                    <span *ngIf="item.number == null ? 0 : item.number.length < item.documentTypeDto.numberMinDigits" class="form-text text-danger">
                      {{ l('TheNumberLengthMustBeMoreThanMinDigits') }}
                    </span>
                    <span
                      *ngIf="item.number == null ? false : item.number.length > item.documentTypeDto.numberMaxDigits"
                      class="form-text text-danger"
                    >
                      {{ l('TheNumberLengthMustBeLessThanMaxDigits') }}
                    </span>
                    <span class="form-text text-muted"
                      >{{ l('minDigits:') }} {{ item.documentTypeDto.numberMinDigits }} {{ l('maxDigits:') }}
                      {{ item.documentTypeDto.numberMaxDigits == 0 ? 50 : item.documentTypeDto.numberMaxDigits }}
                    </span>
                  </div>

                  <div *ngIf="item.documentTypeDto.hasExpirationDate" class="form-group col-6">
                    <hijri-gregorian-datepicker-test
                      [label]="l('ExpirationDate')"
                      class="m-input"
                      [isRequired]="true"
                      [readonly]="true"
                      [minGreg]="todayGregorian"
                      [minHijri]="todayHijri"
                      [selectedDate]="item.documentTypeDto.hasHijriExpirationDate ? todayHijri : todayGregorian"
                      [selectedDateType]="item.documentTypeDto.hasHijriExpirationDate ? selectedDateTypeHijri : selectedDateTypeGregorian"
                      (selectedDateChange)="hijriDatepickerSelectedDateChange($event, item)"
                    >
                    </hijri-gregorian-datepicker-test>
                  </div>
                  <div *ngIf="item.documentTypeDto.hasNotes" class="form-group col-6">
                    <label>{{ l('Note') }}</label>
                    <textarea
                      name="note{{ i }}"
                      id="note{{ i }}"
                      class="form-control m-input"
                      type="text"
                      rows="1"
                      style="resize: none;"
                      [(ngModel)]="item.notes"
                    ></textarea>
                  </div>
                </div>
              </div>
              <div *ngIf="!user.id" class="row">
                <label>{{ docProgressFileName }}</label>
                <div class="col-md-12">
                  <p-progressBar [value]="docProgress" [style]="{ height: '6px', width: '100' }"></p-progressBar>
                </div>
              </div>
            </tab>
          </tabset>
        </div>
        <div class="modal-footer">
          <button [disabled]="saving" type="button" class="btn btn-light-primary font-weight-bold" (click)="close()">
            {{ 'Cancel' | localize }}
          </button>
          <button *ngIf="!user.id" type="submit" class="btn btn-save font-weight-bold" [buttonBusy]="saving" [busyText]="l('SavingWithThreeDot')">
            <i class="fa fa-save"></i> <span>{{ 'Save' | localize }}</span>
          </button>
          <button
            *ngIf="user.id"
            type="submit"
            class="btn btn-save font-weight-bold"
            [disabled]="!userForm.form.valid"
            [buttonBusy]="saving"
            [busyText]="l('SavingWithThreeDot')"
          >
            <i class="fa fa-save"></i> <span>{{ 'Save' | localize }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
