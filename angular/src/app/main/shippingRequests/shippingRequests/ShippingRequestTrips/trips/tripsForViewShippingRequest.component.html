<div class="card card-custom">
  <div class="card-header">
    <h3 class="card-title">
      {{ l('shippingRequestTrips') }}
    </h3>
    <div class="card-toolbar" *ngIf="feature.isEnabled('App.Shipper') || feature.isEnabled('App.TachyonDealer')">
      <button
        class="btn btn-primary"
        *ngIf="ShippingRequest.isTachyonDeal && feature.isEnabled('App.Shipper')"
        (click)="updateAddTripsByTmsFeature()"
        [disabled]="saving"
      >
        <i [class]="tripsByTmsEnabled ? 'fas fa-lock' : 'fas fa-lock-open'"></i>
        {{ tripsByTmsEnabled ? l('DisableAddTripsByTms') : l('EnableAddTripsByTms') }}
      </button>
      <button
        class="btn btn-primary"
        (click)="AddNewTripModal.show()"
        [disabled]="primengTableHelper.totalRecordsCount >= ShippingRequest.numberOfTrips"
        *ngIf="!(feature.isEnabled('App.TachyonDealer') && !ShippingRequest.addTripsByTmsEnabled)"
      >
        <i class="flaticon-plus"></i> {{ l('AddATrip') }}
      </button>
    </div>
  </div>
  <!--begin::card-body-->
  <div class="card-body">
    <div class="row align-items-center">
      <!--<Primeng-Datatable-Start>-->
      <div [busyIf]="primengTableHelper.isLoading" class="primeng-datatable-container col-12">
        <p-table
          #dataTablechild
          (onLazyLoad)="getShippingRequestsTrips($event)"
          [value]="primengTableHelper.records"
          rows="{{ primengTableHelper.defaultRecordsCountPerPage }}"
          [paginator]="false"
          [lazy]="true"
          [scrollable]="true"
          ScrollWidth="100%"
          [responsive]="primengTableHelper.isResponsive"
          [resizableColumns]="primengTableHelper.resizableColumns"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="startTripDate">
                {{ l('startDate') }}
                <p-sortIcon field="startTripDate"></p-sortIcon>
              </th>
              <th pSortableColumn="endTripDate">
                {{ l('endDate') }}
                <p-sortIcon field="endTripDate"></p-sortIcon>
              </th>
              <th pSortableColumn="originFacility">
                {{ l('origin') }}
                <p-sortIcon field="originFacility"></p-sortIcon>
              </th>
              <th pSortableColumn="destinationFacility">
                {{ l('destination') }}
                <p-sortIcon field="destinationFacility"></p-sortIcon>
              </th>
              <th *ngIf="feature.isEnabled('App.Carrier')" pSortableColumn="driverStatusTitle">
                {{ l('driverStatus') }}
                <p-sortIcon field="driverStatusTitle"></p-sortIcon>
              </th>
              <th pSortableColumn="status">
                {{ l('tripStatus') }}
                <p-sortIcon field="status"></p-sortIcon>
              </th>
              <th pSortableColumn="status">
                {{ l('WaybillNumber') }}
                <p-sortIcon field="waybillNo"></p-sortIcon>
              </th>

              <th>
                {{ l('Actions') }}
              </th>
            </tr>
          </ng-template>
          <ng-template let-record="$implicit" pTemplate="body">
            <tr
              [ngClass]="{
                'table-warning': record.hasAccident || record.cancelStatus == ShippingRequestTripCancelStatusEnum.WaitingForTMSApproval,
                'table-danger': record.status === ShippingRequestTripStatusEnum.Canceled
              }"
            >
              <!-- <td style="width: 50px;">
                  <span class="ui-column-title"> {{ l('id') }}</span>
                  {{ record.id }}
                </td> -->
              <td>
                <span class="ui-column-title"> {{ l('startTripDate') }}</span>
                {{ record.startTripDate | momentFormat: 'L' }}
              </td>
              <td>
                <span class="ui-column-title"> {{ l('endTripDate') }}</span>
                {{ record.endTripDate | momentFormat: 'L' }}
              </td>
              <td>
                <span class="ui-column-title"> {{ l('originFacility') }}</span>
                {{ record.originCity }}
              </td>
              <td>
                <span class="ui-column-title"> {{ l('destinationFacility') }}</span>
                {{ record.destinationCity }}
              </td>
              <td *ngIf="feature.isEnabled('App.Carrier')">
                <span class="ui-column-title"> {{ l('driverStatus') }}</span>
                {{ l(record.driverStatusTitle) }}
              </td>

              <td>
                <span class="ui-column-title"> {{ l('tripStatus') }}</span>
                {{ record.statusTitle }}
                <a
                  class="dropdown-item noPadding"
                  *ngIf="record.status == ShippingRequestTripStatusEnum.Canceled"
                  (click)="CancelTripModal.show(record)"
                  ><i class="flaticon-warning text-danger"></i> {{ l('reason') }}</a
                >
                <a (click)="ViewTripAccidentModal.getAll(record)" *ngIf="record.hasAccident"><i class="flaticon-warning text-danger"></i> </a>
              </td>
              <td>
                <span class="ui-column-title"> {{ l('waybillNumber') }}</span>
                {{ record.waybillNumber }}
              </td>

              <td>
                <span class="ui-column-title"> {{ l('Actions') }}</span>
                <div class="btn-group dropdown" container="body" dropdown>
                  <a class="dropdown-toggle btn btn-sm btn-primary" dropdownToggle>
                    <i class="fa fa-cog"></i><span class="caret"></span> {{ l('Actions') }}
                  </a>
                  <ul *dropdownMenu class="dropdown-menu">
                    <li
                      *ngIf="
                        permission.isGranted('Pages.ShippingRequestTrips.Edit') &&
                        feature.isEnabled('App.Shipper') &&
                        record.status == ShippingRequestTripStatusEnum.New
                      "
                    >
                      <a class="dropdown-item" (click)="AddNewTripModal.show(record)">{{ l('Edit') }}</a>
                    </li>
                    <li>
                      <a class="dropdown-item" (click)="ViewTripModal.show(record.id)">{{ l('View') }}</a>
                    </li>
                    <li *ngIf="record.status == ShippingRequestTripStatusEnum.Delivered">
                      <a class="dropdown-item" (click)="shippingRequestRatingModal.show(record.id)">{{ l('Rating') }}</a>
                    </li>
                    <!-- if trip status canceled , No Reset option for trip -->
                    <li
                      *ngIf="
                        record.status != ShippingRequestTripStatusEnum.Canceled &&
                        (feature.isEnabled('App.Carrier') || feature.isEnabled('App.TachyonDealer'))
                      "
                    >
                      <a class="dropdown-item" (click)="ViewTripModal.ResetTrip(record.id)">{{ l('Reset') }}</a>
                    </li>
                    <li *ngIf="record.status != ShippingRequestTripStatusEnum.New">
                      <a class="dropdown-item" (click)="TripAccidentModal.show(record.id, null)">{{ l('CreateAccident') }}</a>
                    </li>
                    <li
                      *ngIf="
                        (!feature.isEnabled('App.TachyonDealer') &&
                          (record.status == ShippingRequestTripStatusEnum.New || record.status == ShippingRequestTripStatusEnum.Intransit) &&
                          record.cancelStatus == ShippingRequestTripCancelStatusEnum.None) ||
                        (feature.isEnabled('App.TachyonDealer') &&
                          (record.status == ShippingRequestTripStatusEnum.New || record.status == ShippingRequestTripStatusEnum.Intransit) &&
                          (record.cancelStatus == ShippingRequestTripCancelStatusEnum.None ||
                            record.cancelStatus == ShippingRequestTripCancelStatusEnum.Rejected))
                      "
                    >
                      <a class="dropdown-item" (click)="CancelTripModal.show(record)">{{ l('Cancel') }}</a>
                    </li>
                    <li
                      *ngIf="
                        feature.isEnabled('App.TachyonDealer') && record.cancelStatus == ShippingRequestTripCancelStatusEnum.WaitingForTMSApproval
                      "
                    >
                      <a class="dropdown-item" (click)="TmsCancelTripModal.ApplyCancel(record)">{{ l('ApplyCancel') }}</a>
                    </li>
                    <li
                      *ngIf="
                        permission.isGranted('Pages.ShippingRequestTrips.Delete') &&
                        feature.isEnabled('App.Shipper') &&
                        record.status == ShippingRequestTripStatusEnum.New
                      "
                    >
                      <a class="dropdown-item" (click)="AddNewTripModal.deleteTrip(record.id)">{{ l('Delete') }}</a>
                    </li>
                    <li>
                      <!--                        <a class="dropdown-item" (click)="AddNewTripModal.printMasterWaybill(record.id)">{{ l('PrintMasterWaybill') }}</a>-->
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <div *ngIf="primengTableHelper.totalRecordsCount == 0" class="primeng-no-data">
          {{ l('NoData') }}
        </div>
        <div class="primeng-paging-container">
          <p-paginator
            #paginatorchild
            (onPageChange)="getShippingRequestsTrips($event)"
            [rows]="primengTableHelper?.defaultRecordsCountPerPage"
            [totalRecords]="primengTableHelper?.totalRecordsCount"
          >
          </p-paginator>
          <span class="total-records-count">
            {{ l('TotalRecordsCount', primengTableHelper.totalRecordsCount) }}
          </span>
        </div>
      </div>
      <!--<Primeng-Datatable-End>-->
    </div>
  </div>
  <!--end::card-body-->
</div>

<AddNewTripModal
  *ngIf="feature.isEnabled('App.Shipper') || feature.isEnabled('App.TachyonDealer')"
  #AddNewTripModal
  (modalSave)="reloadPage()"
  [shippingRequest]="ShippingRequest"
  [VasListFromFather]="VasListFromFather"
></AddNewTripModal>

<app-cancel-trip-modal #CancelTripModal (modalSave)="reloadPage()"></app-cancel-trip-modal>
<app-tms-cancel-trip-modal #TmsCancelTripModal (modalSave)="reloadPage()"></app-tms-cancel-trip-modal>
<viewTripModal #ViewTripModal (modalSave)="reloadPage()"></viewTripModal>
<trip-accident-modal #TripAccidentModal (modalSave)="getShippingRequestsTrips($event)"></trip-accident-modal>
<view-trip-accident-modal #ViewTripAccidentModal (modalcanceltrip)="reloadPage()"></view-trip-accident-modal>
<app-shipping-request-rating-modal #shippingRequestRatingModal></app-shipping-request-rating-modal>
